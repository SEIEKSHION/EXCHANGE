<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Muscles Data</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        /* Стили для селекта */
        #muscle-select {
            padding: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Muscle Measurements</h1>
    
    <label for="muscle-select">Выберите мышцу:</label>
    <select id="muscle-select" name="muscle">
      <option value="">Загрузка...</option>
    </select>
    
    <div style="width: 800px; height: 600px;">
        <canvas id="MuscleMeasurementsChart"></canvas>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // 1. Инициализация переменных (исправлено getElementById)
        const dropdownMenu = document.getElementById('muscle-select');
        const ctx = document.getElementById('MuscleMeasurementsChart').getContext('2d');
        
        // Глобальная переменная для хранения сгруппированных данных
        let groupedMuscles = {};
        let chartInstance = null;

        // 2. Запрос данных
        fetch('/api/muscles') // Добавлен слэш в начало пути
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети')
                }
                return response.json() 
            })
            .then(data => {
                console.log("Imported data:", data)

                // === ГРУППИРОВКА ДАННЫХ ===
                // Используем reduce для разделения массива на объект по именам мышц
                groupedMuscles = data.reduce((acc, muscle) => {
                    // Если такой мышцы еще нет в аккумуляторе, создаем массив
                    if (!acc[muscle.name]) {
                        acc[muscle.name] = [];
                    }
                    // Добавляем текущую запись в массив конкретной мышцы
                    acc[muscle.name].push(muscle);
                    return acc;
                }, {});

                console.log("Grouped data:", groupedMuscles);

                // === ЗАПОЛНЕНИЕ DROPDOWN ===
                dropdownMenu.innerHTML = '<option value="">Выберите мышцу</option>';
                
                // Проходимся по ключам объекта (именам мышц)
                Object.keys(groupedMuscles).forEach(muscleName => {
                    const option = document.createElement('option');
                    option.value = muscleName;
                    option.textContent = muscleName;
                    dropdownMenu.appendChild(option);
                });

                // === СОЗДАНИЕ ГРАФИКА ===
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [], // Даты будут здесь
                        datasets: [{
                            label: "График роста",
                            data: [], // Замеры будут здесь
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });

                // === ОБРАБОТКА ВЫБОРА В DROPDOWN ===
                dropdownMenu.addEventListener('change', function() {
                    const selectedMuscle = this.value;
                    
                    if (selectedMuscle && groupedMuscles[selectedMuscle]) {
                        // Получаем массив замеров для выбранной мышцы
                        const muscleData = groupedMuscles[selectedMuscle];
                        
                        // Сортируем по дате (от старой к новой)
                        muscleData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                        // Разделяем на массивы для графика
                        const labels = muscleData.map(m => {
                            const d = new Date(m.timestamp);
                            return `${d.getDate().toString().padStart(2, '0')}.${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                        });
                        const measures = muscleData.map(m => m.measure);

                        // Обновляем график
                        chartInstance.data.labels = labels;
                        chartInstance.data.datasets[0].data = measures;
                        chartInstance.data.datasets[0].label = `Рост: ${selectedMuscle}`;
                        chartInstance.update();
                    } else {
                        // Если ничего не выбрано, очищаем график
                        chartInstance.data.labels = [];
                        chartInstance.data.datasets[0].data = [];
                        chartInstance.update();
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
                dropdownMenu.innerHTML = '<option value="">Ошибка загрузки</option>';
            });
      });
    </script>
</body>
</html>